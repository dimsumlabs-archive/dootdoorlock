#!/usr/bin/env python3
from urllib.error import HTTPError, URLError
import urllib.request
import urllib.parse
import argparse
import hashlib
import serial
import zmq
import re

from dsldoor import door, create_server_socket


SOCK_PATH = '/tmp/octopusd'
READER_CONF = (
    '/dev/serial/by-id/usb-Silicon_Labs_CP2102_USB_to_UART_Bridge_Controller_0001-if00-port0',  # noqa
    9600)


def rfid_auth(rfid_hash):
    params = urllib.parse.urlencode({'rfid': rfid_hash})
    try:
        r = urllib.request.urlopen('?'.join((
            'http://localhost/api.php', params)))
    except (HTTPError, URLError):
        return False
    else:
        if r.status == 200:
            return True
    return False


if __name__ == '__main__':

    parser = argparse.ArgumentParser(description='DSL octopus reader daemon')
    parser.parse_args()

    conn = serial.Serial(*READER_CONF)

    _, socket = create_server_socket(sock_path=SOCK_PATH, socket_type=zmq.PUB)

    while True:
        rfid_hash = hashlib.sha256(re.sub(
            b'[^0-F]',
            b'',
            conn.readline())).hexdigest()

        socket.send_multipart((b'rfid_last', rfid_hash.encode('utf8')))

        if rfid_auth(rfid_hash):
            door.open()
